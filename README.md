# How to use the JupyterHub

### Create your password and first login

1. Type  `jupyter-kruse.unige.ch` in your web browser.
2. Enter your first name and choose your password

### Add IJulia with optimized kernel
1. Open a terminal
2. Type `julia`
3. copy past
```julia 
using Pkg; 
Pkg.add("IJulia"); 
using IJulia; 
installkernel("Julia opt", "-O3", env=Dict("FOO"=>"yes"))
```

### Restart your server

1. Clic on `File` (top left)
2. Clic on `Hub Control Panel`
3. `Stop my server`
4. `Start my server`

### Install CUDA for Julia

1. Open a Julia opt console
2. Copy paste
```julia
using Pkg
Pkg.add("CUDA")
using CUDA
CUDA.versioninfo()
```

### Create your Code folder and download Utilities
1. Copy this link `https://github.com/Lu-Dumoulin/Utilities` , to easily copy-paste you can press shift during the right-clic in order to have the usual option 
2. Right-clic -> `New Folder`
3. Name your folder
4. Select it in order to have it open
5. Clic on the Git icon and on `Clone a Repository`
6. Paste the link
7. If the Utilities folder is not at the right place you can drag and drop it in the right folder

### Configure the access to the cluster from the jupyter-hub
1. Open a terminal
2. Type `ssh-keygen` and follow instruction
(do not enter un phrase-pass)
3. 

# In case of error:

## Handler error:
1. In a terminal get the list of the kernel: `jupyter kernelspec list`
2. Remove the julia kernels: `jupyter kernelspec uninstall julia-*`
3. Install the new kernel:
` julia `

```julia 
using Pkg; 
Pkg.add("IJulia"); 
using IJulia; 
installkernel("Julia", "-O3", env=Dict("FOO"=>"yes"))
```

# How to use Code to Cluster

## Intro

### The files

### Login
In ssh_login.jl, you have to enter your username
```julia
# Username and host for ssh connection
# the host is the remote server name, I added the '@' for simplicity
username = "dumoulil"; host ="@login2.baobab.hpc.unige.ch"
```
Then the path of your home directory will be automatically saved in `cluster_home_path`:
```julia 
# In ssh_utilities.jl
cluster_home_path = "/home/users/$(username[1])/$username/"
```
and, in order to run an ssh command, you just have to use the function `ssh()` of ssh_utilies.jl:
```julia
# In ssh_utilities.jl
ssh(cmd) = readchomp(`ssh $username$host $cmd`)
```

## General command

## Run a sim on the cluster

### Input Parameters

In order to run your simulation on the cluster using only one line of code, the name of the variable indicating the name of the directory where you want to save data have to be `dir =` .

```julia
dir = "/home/jupyter-ludo/Data/Asters/sim1/" 
mkpath(dir)
```

If you want to download the data generated by your job you have to specify where you want to download the data on your computer `localpath`.
The two `println("... ` lines are mandatory with this exact syntax.

```julia
localpath = "I:/DATA_TEMP/Asters/sim1/"

println("path_c = ", dir)
println("path_l = ", localpath)
```

### run_one_sim() function

The function is:
```julia
run_one_sim(local_code_path, julia_filename, cluster_code_dir, cluster_save_directory, stime; partitions="private-kruse-gpu", mem="3000", sh_name="C2C.sh", input_param_namefile = "InputParameters.jl")
```
One example:
```julia
run_one_sim("D:/Code/mycode/", "something.jl", "mycode/", "Data/test/", "0-00:30:00"; partitions="private-kruse-gpu,shared-gpu")
```
It is also possible to define a "shortcut" function, example:
```julia
cd("D:/Code/")
include("Utilities/Code2Cluster.jl")

# Shortcut to run Mathieu DPD sim on all gpus
runMat_allgpus(dir_clu, stime) = run_one_sim("Mathieu/", "main.jl", "Mathieu/", "Data/Mathieu/"*dir_clu, stime, partitions="private-kruse-gpu,shared-gpu")

# An other shortcut to run Mathieu DPD sim on private gpus
runMat_privategpus(dir_clu, stime) = run_one_sim("Mathieu/", "main.jl", "Mathieu/", "Data/Mathieu/"*dir_clu, stime)

```
and then call it, the data will be save on the cluster in "Data/Mathieu/sim1/", duration of sim 12h:
```julia
runMat_allgpus("sim1/", "0-12:00:00")
```

## Scan a parameter space

### Generate a DataFrame

#### Direct way

Call function:
```julia 
generate_csv(saving_directory, list_col_name, list_tab; name="DF", fn="")
```

#### For specific use
```julia
...
## Rho
tar = [5.0, 7.0, 9.0]
## Friction
txi = [1.0, 10.0, 100.0]

ttype = ["P", "Q", "PQ"]

listname = ["rho0", "rhocr", "ap", "nu", "gamma", "kp", "aq", "lambda", "Gamma", "kq", "zetap", "zetaq", "a", "ar", "xi", "ttype"]
listtab = [tρ0, tρcr, tap, tν, tγ, tkp, taq, tλ, tΓ, tkq, tζp, tζq, ta, tar, txi, ttype];

df = generate_dataframe(listname, listtab; fn="NO");
for i=1:nrow(df)
    df[i, :lambda] = df[i, :nu]
    df[i, :Gamma] = df[i, :gamma]
    if df[i,:ttype]=="Q"
        df[i, :ap] = 0.0
        df[i, :kp] = 0.0
        df[i, :zetap] = 0.0
        df[i, :nu1] = 0.0
        df[i, :gamma] = 0.0
    elseif df[i,:ttype]=="P"
        df[i, :aq] = 0.0
        df[i, :kq] = 0.0
        df[i, :zetaq] = 0.0
        df[i, :lambda] = 0.0
        df[i, :Gamma] = 0.0
    end
end
unique!(df)
insertcols!(df, 1, :fn => 1:nrow(df))
CSV.write(joinpath(dir,"DF.csv"), df)

println("Number of sims :", nrow(df))
```

### How to enter your Input Parameters

#### Input Parameters to explore
```julia
include("../Utilities/julia_utilities.jl")

dir = @__DIR__

# Non-dimensionalized parameters
tρ0 = [0.8, 1.0, 1.2]
tρcr = [0.2]

## Polar
tap = [1.0]
# P - v, h, ΔμP
tν1 = [-1.0]
tγ = [1.0]
tkp = [1.0e-3]

## Nematic
taq = [1.0]
# Q - v, H, ΔμQ
tλ = [-1.0]
tΓ = [1.0]
tkq = [1.0e-3]

## Stress
# Active Polar/Nematic ζpP_zP_z, ζqQ
tζp=[0.0, 0.5, 1.0]
tζq=[0.0, 0.5]
ta = [5.0, 7.0, 9.0]

## Rho
tar = [5.0]
## Friction
txi = [1.0, 10.0, 100.0]

ttype = ["P", "Q", "PQ"]

listname = ["rho0", "rhocr", "ap", "nu1", "gamma", "kp", "aq", "lambda", "Gamma", "kq", "zetap", "zetaq", "a", "ar", "xi", "ttype"]
listtab = [tρ0, tρcr, tap, tν1, tγ, tkp, taq, tλ, tΓ, tkq, tζp, tζq, ta, tar, txi, ttype];

generate_csv(dir, listname, listtab, name="DF")
```

#### Common Input Parameters
The InputParameters.jl file
```julia
include("../Utilities/julia_utilities.jl")
usingpkg("FFTW, Distributions, DelimitedFiles, CSV, DataFrames, Dates, Printf, JLD, CUDA")

idx = Base.parse(Int, ENV["SLURM_ARRAY_TASK_ID"])

dir = "..." 
@show fn = "$idx/"
file = joinpath(dir, fn)
# path to save Data on computer
localpath = "F:/Serie-9/"
mkpath(file)

dir_df = @__DIR__
df = CSV.read(joinpath(dir_df,"DF.csv"), DataFrame)[idx,:]

Tf = Float64

Δx = 4e-3; Δz = 4e-3
Δx2 = Δx*Δx; Δz2 = Δz*Δz
Δt = Tf(1e-4)
L = 10.0
N = L / Δx

WrapsT = 16
Bx = ceil(Int, N/WrapsT)
Bz = ceil(Int, N/WrapsT)
block_dim = (WrapsT, WrapsT)
grid_dim = (Bx, Bz)
gridFFT_dim = (div(Bx,2)+1, Bz)

...

## Polar
ap=Tf(df[:ap])
# P - v, h, ΔμP
ν=Tf(df[:nu]); 
γ=Tf(df[:gamma])
kp=Tf(df[:kp])

## Nematic
aq=Tf(df[:aq])
# Q - v, H, ΔμQ
λ=Tf(df[:lambda]) 
Γ=Tf(df[:Gamma])
kq=Tf(df[:kq])

...

println("path_c = ", dir)
println("path_l = ", localpath)
println(idx)

```

### run_arra_DF() function
```julia
run_array_DF(local_code_path, julia_filename, cluster_code_dir, cluster_save_directory, stime; df_name="DF.csv", partitions="private-kruse-gpu,shared-gpu", mem="3000", sh_name="C2C_array.sh", input_param_namefile = "InputParameters.jl")
```
example:
```julia
run_array_DF("D:/Code/mycode/", "something.jl", "mycode/", "mydata/", "0-12:00:00")
```

### Make your plots and explore the parameter space

# Job info with Blink


```julia

```
